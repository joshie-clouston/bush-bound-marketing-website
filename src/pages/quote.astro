---
export const prerender = true;

import BaseLayout from '@/layouts/BaseLayout.astro';
---

<BaseLayout title="Get a Quote | Bushbound" description="Request a free quote for your custom vehicle fit-out. Tell us about your vehicle and we'll design something perfect.">

  <section class="section-padding bg-background">
    <div class="container-narrow max-w-2xl">
      <a href="/" class="inline-flex items-center text-sm text-primary font-medium mb-8 hover:text-primary-light transition-colors">
        <svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        Back to home
      </a>

      <div class="mb-10">
        <h1 class="text-3xl sm:text-4xl font-bold text-charcoal mb-3" data-animate="fade-up">
          Get a free quote
        </h1>
        <p class="text-muted-foreground text-lg" data-animate="fade-up">
          Tell us about your vehicle and what you're after. We'll get back to you within 48 hours with ideas and a rough quote.
        </p>
      </div>

      <form id="quote-form" class="space-y-6" data-animate="fade-up">
        <!-- Name -->
        <div>
          <label for="name" class="block text-sm font-semibold text-charcoal mb-1.5">Name *</label>
          <input
            type="text"
            id="name"
            name="name"
            required
            autofocus
            class="w-full px-4 py-3 rounded-md border border-stone-dark/30 bg-white text-charcoal placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/40 focus:border-primary transition-colors"
            placeholder="Ben Dover"
          />
        </div>

        <!-- Email -->
        <div>
          <label for="email" class="block text-sm font-semibold text-charcoal mb-1.5">Email *</label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-4 py-3 rounded-md border border-stone-dark/30 bg-white text-charcoal placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/40 focus:border-primary transition-colors"
            placeholder="ben@dover.com"
          />
        </div>

        <!-- Phone -->
        <div>
          <label for="phone" class="block text-sm font-semibold text-charcoal mb-1.5">Phone</label>
          <input
            type="tel"
            id="phone"
            name="phone"
            class="w-full px-4 py-3 rounded-md border border-stone-dark/30 bg-white text-charcoal placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/40 focus:border-primary transition-colors"
            placeholder="04XX XXX XXX"
          />
        </div>

        <!-- Vehicle Type -->
        <div>
          <label for="vehicleType" class="block text-sm font-semibold text-charcoal mb-1.5">Vehicle Type *</label>
          <select
            id="vehicleType"
            name="vehicleType"
            required
            class="w-full px-4 py-3 rounded-md border border-stone-dark/30 bg-white text-charcoal focus:outline-none focus:ring-2 focus:ring-primary/40 focus:border-primary transition-colors"
          >
            <option value="">Select your vehicle type</option>
            <option value="4wd">4WD / Wagon</option>
            <option value="troopy">Toyota Troopy / Troop Carrier</option>
            <option value="van">Van (Sprinter, HiAce, Transit, etc.)</option>
            <option value="ute-canopy">Ute with Canopy</option>
            <option value="other">Other</option>
          </select>
        </div>

        <!-- Vehicle Model -->
        <div>
          <label for="vehicleModel" class="block text-sm font-semibold text-charcoal mb-1.5">Vehicle Make & Model</label>
          <input
            type="text"
            id="vehicleModel"
            name="vehicleModel"
            class="w-full px-4 py-3 rounded-md border border-stone-dark/30 bg-white text-charcoal placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/40 focus:border-primary transition-colors"
            placeholder="e.g. Toyota Land Cruiser 78 Series"
          />
        </div>

        <!-- Service Type -->
        <div>
          <label for="serviceType" class="block text-sm font-semibold text-charcoal mb-1.5">What are you after? *</label>
          <select
            id="serviceType"
            name="serviceType"
            required
            class="w-full px-4 py-3 rounded-md border border-stone-dark/30 bg-white text-charcoal focus:outline-none focus:ring-2 focus:ring-primary/40 focus:border-primary transition-colors"
          >
            <option value="">Select a tier</option>
            <option value="essentials">Essentials (cabinetry & storage)</option>
            <option value="touring">Touring (cabinetry, storage & 12V power)</option>
            <option value="expedition">Expedition (cabinetry, storage, 12V & water)</option>
            <option value="luxury-custom">Luxury Custom (whatever you can imagine!)</option>
            <option value="not-sure">Not sure yet â€” help me figure it out</option>
          </select>
        </div>

        <!-- Message -->
        <div>
          <label for="message" class="block text-sm font-semibold text-charcoal mb-1.5">Tell us more</label>
          <textarea
            id="message"
            name="message"
            rows="4"
            class="w-full px-4 py-3 rounded-md border border-stone-dark/30 bg-white text-charcoal placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/40 focus:border-primary transition-colors resize-y"
            placeholder="What do you need? How do you use your vehicle? Any specific requirements?"
          ></textarea>
        </div>

        <!-- Submit -->
        <button
          type="submit"
          class="w-full sm:w-auto inline-flex items-center justify-center px-8 py-4 bg-primary text-primary-foreground font-bold text-base rounded-md hover:bg-primary-light transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span id="submit-text">Send Quote Request</span>
          <svg id="submit-spinner" class="hidden w-5 h-5 ml-2 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </form>

      <!-- Success message -->
      <div id="success-message" class="hidden mt-8 p-6 bg-primary/10 border border-primary/20 rounded-xl text-center">
        <svg class="w-12 h-12 text-primary mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3 class="text-xl font-bold text-charcoal mb-1">Quote request sent!</h3>
        <p class="text-muted-foreground">We'll be in touch within 48 hours. Keep an eye on your inbox.</p>
      </div>

      <!-- Error message -->
      <div id="error-message" class="hidden mt-8 p-6 bg-destructive/10 border border-destructive/20 rounded-xl text-center">
        <h3 class="text-xl font-bold text-charcoal mb-1">Something went wrong</h3>
        <p class="text-muted-foreground">Please try again or email us directly at <a href="mailto:hello@bushbound.au" class="text-primary underline">hello@bushbound.au</a></p>
      </div>
    </div>
  </section>

  <script>
    const form = document.getElementById('quote-form') as HTMLFormElement;
    const submitText = document.getElementById('submit-text')!;
    const submitSpinner = document.getElementById('submit-spinner')!;
    const successMessage = document.getElementById('success-message')!;
    const errorMessage = document.getElementById('error-message')!;

    // Pre-select service type from URL params
    const params = new URLSearchParams(window.location.search);
    const serviceParam = params.get('type');
    if (serviceParam) {
      const serviceSelect = document.getElementById('serviceType') as unknown as HTMLSelectElement;
      const option = serviceSelect.querySelector(`option[value="${serviceParam}"]`);
      if (option) serviceSelect.value = serviceParam;
    }

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const button = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      button.disabled = true;
      submitText.textContent = 'Sending...';
      submitSpinner.classList.remove('hidden');
      errorMessage.classList.add('hidden');

      const data = Object.fromEntries(new FormData(form));

      // Capture UTM params
      const utmKeys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'];
      const utmParams = new URLSearchParams(window.location.search);
      const utm: Record<string, string> = {};
      for (const key of utmKeys) {
        const val = utmParams.get(key);
        if (val) utm[key] = val;
      }

      try {
        const response = await fetch('/api/quote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...data, ...utm }),
        });

        if (!response.ok) throw new Error('Request failed');

        form.classList.add('hidden');
        successMessage.classList.remove('hidden');
      } catch {
        errorMessage.classList.remove('hidden');
        button.disabled = false;
        submitText.textContent = 'Send Quote Request';
        submitSpinner.classList.add('hidden');
      }
    });
  </script>

</BaseLayout>
